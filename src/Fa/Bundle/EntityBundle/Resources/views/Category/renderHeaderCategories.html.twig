{% set container = fetch_container_instance() %}
{% set entityCacheManager = container.get('fa.entity.cache.manager') %}
{% set categoryRepository = fetch_repository('FaEntityBundle:Category') %}

{% if headerCategories|length %}
{% cache 'header|menu|'~location_id|replace({' ':''})~'front/header_menu' ~ (thirdPartyAdultModalBox is defined and thirdPartyAdultModalBox?1:0 ) (staticCall('Fa\\Bundle\\CoreBundle\\Manager\\CommonManager', 'isBot', [container]) ? 600 : 86400) %}
    {% for categoryId, categoryArray in headerCategories %}
        {% set linkParam = { 'item__location': location_id, 'item__category_id': categoryId} %}
        {% if categoryId == constant('Fa\\Bundle\\EntityBundle\\Repository\\CategoryRepository::FOR_SALE_ID')
            or categoryId == constant('Fa\\Bundle\\EntityBundle\\Repository\\CategoryRepository::MOTORS_ID')
            or categoryId == constant('Fa\\Bundle\\EntityBundle\\Repository\\CategoryRepository::ANIMALS_ID')
            or categoryId == constant('Fa\\Bundle\\EntityBundle\\Repository\\CategoryRepository::PROPERTY_ID')
            or categoryId == constant('Fa\\Bundle\\EntityBundle\\Repository\\CategoryRepository::JOBS_ID') %}
            {% set listurl = container.get('fa_ad.manager.ad_routing').getCategoryLandingPageUrl(linkParam) %}
        {% else %}
            {% set listurl = container.get('fa_ad.manager.ad_routing').getCategoryUrl(location_id, categoryArray['full_slug']) %}
        {% endif %}
		{% if mobileDetectManager.isTablet() %}
			<div class="category-links">
                <h6 class="link-head"><a href="{{ listurl }}">{{categoryArray['name']}}</a></h6>
                {% if categoryArray['children'] is defined and categoryArray['children']|length %}
                    {% if categoryId == constant('Fa\\Bundle\\EntityBundle\\Repository\\CategoryRepository::MOTORS_ID') %}
                        {% set staticPageUrls = fetch_repository('FaContentBundle:SeoTool').getLandingPageStaticPageUrlArray('motors', container, location_id) %}
                        {% set categoryArray  = append_to_array_by_index(categoryArray, {'10000': {'is_static': true, 'link_url' : (staticPageUrls['Classic cars']), 'link_text' : 'Classic Cars'}}, 'children') %}
                    {% endif %}
                    {% if categoryId == constant('Fa\\Bundle\\EntityBundle\\Repository\\CategoryRepository::FOR_SALE_ID') %}
                        {% set freeToCollectorUrl = container.get('fa_ad.manager.ad_routing').getListingUrl({'item__category_id': constant('Fa\\Bundle\\EntityBundle\\Repository\\CategoryRepository::FOR_SALE_ID'), 'item__ad_type_id' : constant('Fa\\Bundle\\EntityBundle\\Repository\\EntityRepository::AD_TYPE_FREETOCOLLECTOR_ID'), 'item__location': location}) %}
                        {% set categoryArray  = append_to_array_by_index(categoryArray, {'10001': {'is_static': true, 'link_url' : (freeToCollectorUrl), 'link_text' : 'Free to Collector'}}, 'children') %}
                    {% endif %}
                    {% if categoryId == constant('Fa\\Bundle\\EntityBundle\\Repository\\CategoryRepository::JOBS_ID') %}
                        {% set staticPageUrls = fetch_repository('FaContentBundle:SeoTool').getLandingPageStaticPageUrlArray('jobs', container, location_id) %}
                        {% set categoryArray  = append_to_array_by_index(categoryArray, {'10002': {'is_static': true, 'link_url' : (staticPageUrls['Part-time, Evening & Weekend']), 'link_text' : 'Part-time, Evening & Weekend', 'name' : 'Part-time, Evening & Weekend'}}, 'children') %}
                        {% set sortedCategoryArray = msort(categoryArray['children'], 'name') %}
                        {% set categoryArray  = replace_value_in_array(categoryArray, 'children', sortedCategoryArray) %}
                    {% endif %}
                    <div class="list-parent-link">
                        <ul>
                        	{% set columns = 3 %}
                             {% set ctr = 0 %}
                             {% set totalItems = categoryArray['children']|length %}
                             {% if categoryId == constant('Fa\\Bundle\\EntityBundle\\Repository\\CategoryRepository::ADULT_ID') %}
                                 {% set totalItems = totalItems + 1 %}
                             {% endif %}
                             {% set itemsPerCol = (totalItems/columns)|round(0, 'floor') %}
                             {% set extraColumn = (totalItems % columns) %}
                             {% set colCounter = {} %}
                             {% set staticTxtCnt = 0 %}
                             {% for i in 0..columns-1 %}
                                 {% if loop.index0 < extraColumn %}
                                     {% set colCounter = colCounter|merge({0: itemsPerCol + 1}) %}
                                 {% else  %}
                                     {% set colCounter = colCounter|merge({0: itemsPerCol}) %}
                                 {% endif %}
                             {% endfor %}
                             {% set subCategoryArray = categoryArray['children']|keys %}
                             {% for i in 0..columns-1 %}
                                     {% for k in 0..colCounter[i]-1 %}
                                         {% if subCategoryArray[ctr] is defined %}
                                            {% if categoryArray['children'][subCategoryArray[ctr]]['is_static'] is defined and categoryArray['children'][subCategoryArray[ctr]]['is_static'] %}
                                                <li class="parent-link"><a href="{{ categoryArray['children'][subCategoryArray[ctr]]['link_url'] }}" class="inside-top-category-menu">{{ categoryArray['children'][subCategoryArray[ctr]]['link_text'] }}</a></li>
                                            {% else %}
                                                {% set listurl1 = container.get('fa_ad.manager.ad_routing').getCategoryUrl(location_id, categoryArray['children'][subCategoryArray[ctr]]['full_slug']) %}
                                                <li class="parent-link"><a href="{{ listurl1 }}" class="inside-top-category-menu">{{categoryArray['children'][subCategoryArray[ctr]]['name']}}</a></li>
                                            {% endif %}
                                         {% endif %}
                                         {% set ctr = ctr + 1 %}
                                     {% endfor %}                                
                             {% endfor %}
                        </ul>
                    </div>
                {% endif %}
            </div>
		{% elseif mobileDetectManager.isMobile() %}
			<li>
				<a href="{{ listurl }}" class="remove-arrow-f-child"><span class="mob-forsale">&nbsp;</span><span class="menu-head-ad">{{categoryArray['name']}}</span> <span class="count-ads"></span></a>
				<ul class="dl-submenu">
					<li><a href="{{ listurl }}" class="active-subcat"><span class="mob-forsale">&nbsp;</span><span class="menu-head-ad">{{categoryArray['name']}}</span> <span class="count-ads"></span></a></li>
                    {% set secondLevelLength = 0 %}
                    {% if categoryArray['children'] is defined and categoryArray['children']|length %}
                        {% set secondLevelLength = categoryArray['children']|length %}
                    {% endif %}
                    <li {% if secondLevelLength %}class="has-dropdown"{% else %}class="last-level"{% endif %}>
                        {% set listurl1 = container.get('fa_ad.manager.ad_routing').getCategoryUrl(location_id, categoryArray['full_slug']) %}
                        <a href="{{ listurl1 }}" class="main_category">{% if categoryArray['class'] is defined %}<span class="{{categoryArray['class']}}">&nbsp;</span>{% endif %}{{categoryArray['name']}} <span>({{ categoryArray['count'] is defined?categoryArray['count']|number_format:0}} {{'ads'|trans()}})</span></a>
                        {% if secondLevelLength %}
                            <ul class="dl-submenu">
                                    {% for secondLevelCategoryId, secondLevelCategoryArray in categoryArray['children'] %}
                                        {% set thirdLevelLength = 0 %}
                                        {% if secondLevelCategoryArray['children'] is defined and secondLevelCategoryArray['children']|length %}
                                            {% set thirdLevelLength = secondLevelCategoryArray['children']|length %}
                                        {% endif %}
                                        <li {% if thirdLevelLength %}class="has-dropdown"{% else %}class="last-level"{% endif %}>
                                        {% if secondLevelCategoryArray['is_static'] is defined and secondLevelCategoryArray['is_static'] %}
                                            {% set listurl1 = secondLevelCategoryArray['link_url'] %}
                                        {% else %}
                                            {% set listurl1 = container.get('fa_ad.manager.ad_routing').getCategoryUrl(location_id, secondLevelCategoryArray['full_slug']) %}
                                        {% endif %}
                                        <a href="{{ listurl1 }}">{% if secondLevelCategoryArray['is_static'] is defined and secondLevelCategoryArray['is_static'] %} {{secondLevelCategoryArray['link_text']}} {% else %}{{secondLevelCategoryArray['name']}}{% endif %}</a>
                                        {% if thirdLevelLength %}
                                             <ul class="dl-submenu">
                                                 {% for thirdLevelCategoryId, thirdLevelCategoryArray in secondLevelCategoryArray['children'] %}
                                                    {% set fourthLevelLength = 0 %}
                                                    {% if thirdLevelCategoryArray['children'] is defined and thirdLevelCategoryArray['children']|length %}
                                                        {% set fourthLevelLength = thirdLevelCategoryArray['children']|length %}
                                                    {% endif %}
                                                    <li {% if fourthLevelLength %}class="has-dropdown"{% else %}class="last-level"{% endif %}>
                                                    {% set listurl1 = container.get('fa_ad.manager.ad_routing').getCategoryUrl(location_id, thirdLevelCategoryArray['full_slug']) %}
                                                     <a href="{{ listurl1 }}">{{thirdLevelCategoryArray['name']}}</a>
                                                     {% if fourthLevelLength %}
                                                         <ul class="dl-submenu">
                                                             {% for fourthLevelCategoryId, fourthLevelCategoryArray in thirdLevelCategoryArray['children'] %}
                                                                {% set fifthLevelLength = 0 %}
                                                                {% if fourthLevelCategoryArray['children'] is defined and fourthLevelCategoryArray['children']|length %}
                                                                    {% set fifthLevelLength = fourthLevelCategoryArray['children']|length %}
                                                                {% endif %}
                                                                 <li {% if fifthLevelLength %}class="has-dropdown"{% else %}class="last-level"{% endif %}>
                                                                 {% set listurl1 = container.get('fa_ad.manager.ad_routing').getCategoryUrl(location_id, fourthLevelCategoryArray['full_slug']) %}
                                                                 <a href="{{ listurl1 }}">{{fourthLevelCategoryArray['name']}}</a>
                                                                 {% if fifthLevelLength %}
                                                                     <ul class="dl-submenu">
                                                                         {% for fifthLevelCategoryId, fifthLevelCategoryArray in fourthLevelCategoryArray['children'] %}
                                                                            {% set sixthLevelLength = 0 %}
                                                                            {% if fifthLevelCategoryArray['children'] is defined and fifthLevelCategoryArray['children']|length %}
                                                                                {% set sixthLevelLength = fifthLevelCategoryArray['children']|length %}
                                                                            {% endif %}
                                                                            <li {% if sixthLevelLength %}class="has-dropdown"{% else %}class="last-level"{% endif %}>
                                                                            {% set listurl1 = container.get('fa_ad.manager.ad_routing').getCategoryUrl(location_id, fifthLevelCategoryArray['full_slug']) %}
                                                                             <a href="{{ listurl1 }}">{{fifthLevelCategoryArray['name']}}</a>
                                                                             {% if sixthLevelLength %}
                                                                                 <ul class="dl-submenu">
                                                                                     {% for sixthLevelCategoryId, sixthLevelCategoryArray in fifthLevelCategoryArray['children'] %}
                                                                                         <li class="last-level">
                                                                                            {% set listurl1 = container.get('fa_ad.manager.ad_routing').getCategoryUrl(location_id, sixthLevelCategoryArray['full_slug']) %}
                                                                                            <a href="{{ listurl1 }}">{{sixthLevelCategoryArray['name']}}</a>
                                                                                         </li>
                                                                                     {% endfor %}
                                                                                 </ul>
                                                                             {% endif %}
                                                                             </li>
                                                                         {% endfor %}
                                                                     </ul>
                                                                 {% endif %}
                                                             {% endfor %}
                                                             </li>
                                                         </ul>
                                                     {% endif %}
                                                     </li>
                                                 {% endfor %}
                                             </ul>
                                         {% endif %}
                                         </li>
                                         
                                    {% endfor %}
                                    <li class="last-level">
                                        {% if categoryId == constant('Fa\\Bundle\\EntityBundle\\Repository\\CategoryRepository::MOTORS_ID') %}
                                            {% set staticPageUrls = fetch_repository('FaContentBundle:SeoTool').getLandingPageStaticPageUrlArray('motors', container, location_id) %}
                                            {% if staticPageUrls['Classic cars'] is defined %}
                                                <a href="{{ staticPageUrls['Classic cars'] }}">Classic Cars</a>
                                            {% endif %}
                                         {% endif %}
                                    </li>
                                    <li class="last-level">
                                        {% if categoryId == constant('Fa\\Bundle\\EntityBundle\\Repository\\CategoryRepository::FOR_SALE_ID') %}
                                            {% set freeToCollectorUrl = container.get('fa_ad.manager.ad_routing').getListingUrl({'item__category_id': constant('Fa\\Bundle\\EntityBundle\\Repository\\CategoryRepository::FOR_SALE_ID'), 'item__ad_type_id' : constant('Fa\\Bundle\\EntityBundle\\Repository\\EntityRepository::AD_TYPE_FREETOCOLLECTOR_ID'), 'item__location': location}) %}
                                            {% if freeToCollectorUrl %}
                                                <a href="{{ freeToCollectorUrl }}">Free to Collector</a>
                                            {% endif %}
                                         {% endif %}
                                    </li>
                            </ul>
                        {% endif %}				
				</ul>
			</li>
		{% else %}
		<li class="nav-item dropdown d-navbar-block">
            <a href="{{ listurl }}" class="nav-link dropdown-toggle main_category" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">{{categoryArray['name']}}</a>
            {% if categoryArray['children'] is defined and categoryArray['children']|length %}
                {% if categoryId == constant('Fa\\Bundle\\EntityBundle\\Repository\\CategoryRepository::MOTORS_ID') %}
                    {% set staticPageUrls = fetch_repository('FaContentBundle:SeoTool').getLandingPageStaticPageUrlArray('motors', container, location_id) %}
                    {% set categoryArray  = append_to_array_by_index(categoryArray, {'10000': {'is_static': true, 'link_url' : (staticPageUrls['Classic cars']), 'link_text' : 'Classic Cars'}}, 'children') %}
                {% endif %}
                {% if categoryId == constant('Fa\\Bundle\\EntityBundle\\Repository\\CategoryRepository::FOR_SALE_ID') %}
                    {% set freeToCollectorUrl = container.get('fa_ad.manager.ad_routing').getListingUrl({'item__category_id': constant('Fa\\Bundle\\EntityBundle\\Repository\\CategoryRepository::FOR_SALE_ID'), 'item__ad_type_id' : constant('Fa\\Bundle\\EntityBundle\\Repository\\EntityRepository::AD_TYPE_FREETOCOLLECTOR_ID'), 'item__location': location}) %}
                    {% set categoryArray  = append_to_array_by_index(categoryArray, {'10001': {'is_static': true, 'link_url' : (freeToCollectorUrl), 'link_text' : 'Free to Collector'}}, 'children') %}
                {% endif %}
                {% if categoryId == constant('Fa\\Bundle\\EntityBundle\\Repository\\CategoryRepository::JOBS_ID') %}
                    {% set staticPageUrls = fetch_repository('FaContentBundle:SeoTool').getLandingPageStaticPageUrlArray('jobs', container, location_id) %}
                    {% set categoryArray  = append_to_array_by_index(categoryArray, {'10002': {'is_static': true, 'link_url' : (staticPageUrls['Part-time, Evening & Weekend']), 'link_text' : 'Part-time, Evening & Weekend', 'name' : 'Part-time, Evening & Weekend'}}, 'children') %}
                    {% set sortedCategoryArray = msort(categoryArray['children'], 'name') %}
                    {% set categoryArray  = replace_value_in_array(categoryArray, 'children', sortedCategoryArray) %}
                {% endif %}
                
                <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                    <div class="container">
                        <div class="row">
                            <div class="col-md-24 category-link">
                            {% set columns = 4 %}
                            {% set ctr = 0 %}
                            {% set totalItems = categoryArray['children']|length %}
                            {% if categoryId == constant('Fa\\Bundle\\EntityBundle\\Repository\\CategoryRepository::ADULT_ID') %}
                            	{% set totalItems = totalItems + 1 %}
                            {% endif %}
                            {% set itemsPerCol = (totalItems/columns)|round(0, 'floor') %}
                            {% set extraColumn = (totalItems % columns) %}
                            {% set colCounter = {} %}
                            {% set staticTxtCnt = 0 %}
                            {% for i in 0..columns-1 %}
                                {% if loop.index0 < extraColumn %}
                                    {% set colCounter = colCounter|merge({0: itemsPerCol + 1}) %}
                                {% else  %}
                                    {% set colCounter = colCounter|merge({0: itemsPerCol}) %}
                                {% endif %}
                            {% endfor %}
                            {% set subCategoryArray = categoryArray['children']|keys %}
                            {% for i in 0..columns-1 %}
                                    {% for k in 0..colCounter[i]-1 %}
                                        {% if subCategoryArray[ctr] is defined %}
                                            {% if categoryArray['children'][subCategoryArray[ctr]]['is_static'] is defined and categoryArray['children'][subCategoryArray[ctr]]['is_static'] %}
                                                <div class="parent-link"><a href="{{ categoryArray['children'][subCategoryArray[ctr]]['link_url'] }}">{{ categoryArray['children'][subCategoryArray[ctr]]['link_text'] }}</a></div>
                                            {% else %}
                                                {% if secondLevelCategoryArray['is_static'] is defined and secondLevelCategoryArray['is_static'] %}
                                                    {% set listurl1 = secondLevelCategoryArray['link_url'] %}
                                                {% else %}
                                                    {% set listurl1 = container.get('fa_ad.manager.ad_routing').getCategoryUrl(location_id, categoryArray['children'][subCategoryArray[ctr]]['full_slug']) %}
                                                {% endif %}
                                                <div class="parent-link"><a href="{{ listurl1 }}">{{categoryArray['children'][subCategoryArray[ctr]]['name']}}</a></div>
                                            {% endif %}
                                        {% endif %}
                                        {% set ctr = ctr + 1 %}
                                    {% endfor %}
                            {% endfor %}                                
                           </div>
                        </div>
                    </div>
                </div>
              {% endif %}  
            </li>
         {% endif %}  
    {% endfor %}
{% endcache %}
{% endif %}
                