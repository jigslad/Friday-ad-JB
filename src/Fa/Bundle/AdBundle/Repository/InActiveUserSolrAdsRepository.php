<?php

/**
 * This file is part of the fa bundle.
 *
 * @copyright Copyright (c) 2014, FMG
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 */

namespace Fa\Bundle\AdBundle\Repository;

use Doctrine\ORM\EntityRepository;
use Fa\Bundle\UserBundle\Repository\UserRepository;


/**
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 *
 * @author Vijay <vijay.namburi@fridaymediafroup.com>
 * @copyright 2018 Friday Media Group Ltd
 * @version v1.0
 */
class InActiveUserSolrAdsRepository extends EntityRepository
{
    use \Fa\Bundle\CoreBundle\Search\Search;
    const ALIAS = 'iaus';

    /**
     * PrepareQueryBuilder.
     *
     * @param array $data Array of data.
     *
     * @return Doctrine\ORM\QueryBuilder The query builder.
     */
    public function getBaseQueryBuilder()
    {
        return $this->createQueryBuilder(self::ALIAS);
    }
    
    public function getInActiveUserAdsInSolr($request,$searchParams=array(),$sorter=array()) { 

    	$qb = $this->createQueryBuilder(self::ALIAS)
    		->select(self::ALIAS.'.adId', self::ALIAS.'.userId', UserRepository::ALIAS.'.email', self::ALIAS.'.adStatus', self::ALIAS.'.userStatus', self::ALIAS.'.status')
	    	->innerJoin('Fa\Bundle\AdBundle\Entity\Ad', AdRepository::ALIAS, 'WITH', self::ALIAS.'.adId = '.AdRepository::ALIAS.'.id')
	    	->innerJoin('Fa\Bundle\UserBundle\Entity\User', UserRepository::ALIAS, 'WITH', self::ALIAS.'.userId = '.UserRepository::ALIAS.'.id');
    	
        if(($request->query->has('status') && $request->query->get('status') == 'success') or ($request->query->has('fa_solr_report') && $request->query->get('fa_solr_report')['status'] == 'success')) {
            $qb->where(self::ALIAS.'.status = 1');          
        } else {
            $qb->where(self::ALIAS.'.status = 0');
        }

        if(!empty($searchParams)) {
            if($searchParams['ad__id']!='') {
                $qb->andWhere(self::ALIAS.'.adId = '.$searchParams['ad__id']);  
            }
            if($searchParams['user__id']!='') {
                $qb->andWhere(self::ALIAS.'.userId = '.$searchParams['user__id']);  
            }
            if($searchParams['user__email']!='') {
                $qb->andWhere(UserRepository::ALIAS.".email = '".$searchParams['user__email']."'");  
            }
            if($searchParams['user__status']!='') {
                $qb->andWhere(self::ALIAS.".userStatus = '".$searchParams['user__status']."'");  
            }
            if($searchParams['ad__status']!='') {
                $qb->andWhere(self::ALIAS.".adStatus = '".$searchParams['ad__status']."'");  
            }
        }

        if(!empty($sorter)) {
            if($sorter['sort_field']=='ad__id') {
                $qb->orderBy(self::ALIAS.'.adId',$sorter['sort_ord']);  
            }
            elseif($sorter['sort_field']=='user__id') {
                $qb->orderBy(self::ALIAS.'.userId',$sorter['sort_ord']);  
            }
            elseif($sorter['sort_field']=='user__email') {
                $qb->orderBy(UserRepository::ALIAS.'.email',$sorter['sort_ord']);  
            }
            elseif($sorter['sort_field']=='user__status') {
                $qb->orderBy(self::ALIAS.'.userStatus',$sorter['sort_ord']);  
            }
            elseif($sorter['sort_field']=='ad__status') {
                $qb->orderBy(self::ALIAS.'.adStatus',$sorter['sort_ord']);  
            }

        }

        return $qb->getQuery();
    }
}