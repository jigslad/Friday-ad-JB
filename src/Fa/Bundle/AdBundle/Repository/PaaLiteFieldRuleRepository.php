<?php

/**
 * This file is part of the fa bundle.
 *
 * @copyright Copyright (c) 2018, FMG
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 */

namespace Fa\Bundle\AdBundle\Repository;

use Doctrine\ORM\EntityRepository;
use Fa\Bundle\CoreBundle\Manager\CommonManager;
use Fa\Bundle\AdBundle\Repository\PaaFieldRepository;
use Doctrine\ORM\Query;
use Fa\Bundle\CoreBundle\Walker\SortableNullsWalker;

/**
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 *
 * @author Rohini <rohini.subburam@fridaymediagroup.com>
 * @copyright 2018 Friday Media Group Ltd
 * @version 1.0
 */
class PaaLiteFieldRuleRepository extends EntityRepository
{
    use \Fa\Bundle\CoreBundle\Search\Search;

    const ALIAS = 'plfr';

    const MIN_MAX_TYPE_LENGTH = 'LENGTH';
    const MIN_MAX_TYPE_RANGE  = 'RANGE';

    /**
     * Prepare query builder.
     *
     * @param array $data Array of data.
     *
     * @return Doctrine\ORM\QueryBuilder The query builder.
     */
    public function getBaseQueryBuilder()
    {
        return $this->createQueryBuilder(self::ALIAS);
    }

    /**
     * Get category wise PAA field rules query.
     *
     * @param integer $categoryId Category id.
     * @param string  $ordBy      Order by ord, step or both
     *
     * @return object
     */
    public function getPaaLiteFieldRulesQueryBuilderByCategoryId($categoryId = null, $ordBy = 'ord')
    {
        $queryBuilder = $this->getBaseQueryBuilder()
                        ->select(self::ALIAS, PaaFieldRepository::ALIAS)
                        ->leftJoin(self::ALIAS.'.paa_lite_field', PaaFieldRepository::ALIAS)
                        ->where(self::ALIAS.'.category = '.$categoryId);

        if ($ordBy == 'both' || $ordBy == 'bothWithNullLast') {
            $queryBuilder->addOrderBy(self::ALIAS.'.step', 'asc')
                         ->addOrderBy(self::ALIAS.'.ord', 'asc');
        } else {
            $queryBuilder->addOrderBy(self::ALIAS.'.'.$ordBy, 'asc');
        }
        
        return $queryBuilder;
    }

    /**
     * Get category wise PAA field rules.
     *
     * @param integer $categoryId Category id.
     *
     * @return array
     */
    public function getPaaLiteFieldRulesByCategoryId($categoryId = null, $ordBy = 'ord')
    {
        $query = $this->getPaaLiteFieldRulesQueryBuilderByCategoryId($categoryId, $ordBy)->getQuery();
        if ($ordBy == 'bothWithNullLast') {
            $query
            ->setHint(Query::HINT_CUSTOM_OUTPUT_WALKER,  'Fa\Bundle\CoreBundle\Walker\SortableNullsWalker')
            ->setHint('SortableNullsWalker.fields', array(
                'step' => SortableNullsWalker::NULLS_LAST,
            ));
        }
        return $query->getResult();
    }

    /**
     * Get category wise PAA field rules which needs to show in form.
     *
     * @param integer $categoryId Category id.
     *
     * @return array
     */
    public function getActivePaaLiteFieldRulesByCategoryId($categoryId = null)
    {
        $queryBuilder = $this->getPaaLiteFieldRulesQueryBuilderByCategoryId($categoryId);

        return $queryBuilder->andWhere(self::ALIAS.'.status = 1')->getQuery()->getResult();
    }

    /**
     * Get show hide array.
     *
     * @param Container $container Container identifier.
     * @param boolean   $addEmpty  Flag to show empty message.
     *
     * @return array
     */
    public static function getStatusArray($container, $addEmpty = true)
    {
        $translator  = CommonManager::getTranslator($container);
        $statusArray = array();

        if ($addEmpty) {
            $statusArray[''] = $translator->trans('Both (Show & Hide)');
        }

        $statusArray[1] = $translator->trans('Show');
        $statusArray[0] = $translator->trans('Hide');

        return $statusArray;
    }

    /**
     * Add status filter.
     *
     * @param mixed $status Entity type
     */
    protected function addStatusFilter($status = null)
    {
        $this->queryBuilder->andWhere($this->getRepositoryAlias().'.status = '.$status);
    }

    /**
     * Get PAA fields by category or category ancestor.
     *
     * @param mixed $categoryId Category id.
     *
     * @return array
     */
    public function getActivePaaLiteFieldsRulesByCategoryAncestor($categoryId = null)
    {
        // If given category have not PAA field rules defined then find by their parent categories.
        $PaaLiteFieldRules = $this->getActivePaaLiteFieldRulesByCategoryId($categoryId);

        if (!count($PaaLiteFieldRules)) {
            $category = $this->_em->getRepository('FaEntityBundle:Category')->find($categoryId);
            if ($category && $category->getLvl() > 1) {
                $parent = $category->getParent();
                return $this->getActivePaaLiteFieldsRulesByCategoryAncestor($parent->getId());
            }
        }

        return $PaaLiteFieldRules;
    }

    /**
     * Get PAA fields by category or category ancestor.
     *
     * @param mixed $categoryId Category id.
     *
     * @return array
     */
    public function getPaaLiteFieldRulesByCategoryAncestor($categoryId = null, $ordBy = 'ord')
    {
        $PaaLiteFieldRules = $this->getPaaLiteFieldRulesByCategoryId($categoryId, $ordBy);

        if ($PaaLiteFieldRules && count($PaaLiteFieldRules)) {
            return $PaaLiteFieldRules;
        } else {
            $categoryObj = $this->_em->getRepository('FaEntityBundle:Category')->find($categoryId);
            if ($categoryObj && $categoryObj->getLvl() > 1) {
                $parentObj = $categoryObj->getParent();
                return $this->getPaaLiteFieldRulesByCategoryAncestor($parentObj->getId());
            }
        }
    }

    /**
     * Get PAA fields by category or category ancestor.
     *
     * @param mixed   $categoryId Category id.
     * @param mixed   $container  Container identifier.
     * @param integer $step       Field Step.
     * @param string  $ordBy      Ordered by ord, step or both.
     *
     * @return array
     */
    public function getPaaLiteFieldRulesArrayByCategoryAncestor($categoryId = null, $container = null, $step = null, $ordBy = 'ord')
    {
        $PaaLiteFieldRules = $this->getPaaLiteFieldRulesArrayByCategoryId($categoryId, $container, $step, $ordBy);

        if (isset($PaaLiteFieldRules[$categoryId]) && count($PaaLiteFieldRules[$categoryId])) { 
            return $PaaLiteFieldRules[$categoryId];
        } else {
            $categoryPath = $this->_em->getRepository('FaEntityBundle:Category')->getCategoryPathArrayById($categoryId, false, $container);
            $categoryIds  = array_keys($categoryPath);
            if ($categoryIds && count($categoryIds) > 1) {
                $parentCategoryId = $categoryIds[(count($categoryIds) - 2)];
                return $this->getPaaLiteFieldRulesArrayByCategoryAncestor($parentCategoryId, $container, $step, $ordBy);
            }
        }
    }

    /**
     * Get category wise PAA field rules.
     *
     * @param mixed   $categoryId Category id.
     * @param mixed   $container  Container identifier.
     * @param integer $step       Field Step.
     * @param string  $ordBy      Ordered by ord, step or both.
     *
     * @return array
     */
    public function getPaaLiteFieldRulesArrayByCategoryId($categoryId = null, $container = null, $step = null, $ordBy = 'ord')
    {
        if ($container) {
            $culture     = CommonManager::getCurrentCulture($container);
            $cacheKey    = $this->getTableName().'|'.__FUNCTION__.'|'.$categoryId.'_'.$step.'_'.$ordBy.'_'.$culture;
            $cachedValue = CommonManager::getCacheVersion($container, $cacheKey);

            if ($cachedValue !== false) { 
                return $cachedValue;
            }
        }

        $PaaLiteFieldRulesArray = array();

        $queryBuilder = $this->getPaaLiteFieldRulesQueryBuilderByCategoryId($categoryId, $ordBy);
        if ($step) {
            $queryBuilder->andWhere(self::ALIAS.'.step = :step')->setParameter('step', $step);
        }

        $PaaLiteFieldRules = $queryBuilder->getQuery()->getArrayResult();
        $PaaLiteFieldRulesArray[$categoryId] = $PaaLiteFieldRules;

        if ($container) {
            CommonManager::setCacheVersion($container, $cacheKey, $PaaLiteFieldRulesArray);
        }

        return $PaaLiteFieldRulesArray;
    }

    /**
     * Get table name.
     */
    private function getTableName()
    {
        return $this->_em->getClassMetadata('FaAdBundle:PaaLiteFieldRule')->getTableName();
    }

    /**
     * Get reg no fields category ids
     *
     * @param integer $categoryId Category id.
     * @param string  $ordBy      Order by ord, step or both
     *
     * @return object
     */
    public function getRegNoFieldCategoryIds($container)
    {
        if ($container) {
            $culture     = CommonManager::getCurrentCulture($container);
            $cacheKey    = $this->getTableName().'|'.__FUNCTION__.'|_'.$culture;
            $cachedValue = CommonManager::getCacheVersion($container, $cacheKey);

            if ($cachedValue !== false) {
                return $cachedValue;
            }
        }

        $regNoFieldCategoryIds = array();

        $queryBuilder = $this->getBaseQueryBuilder()
        ->select(self::ALIAS.'.id', 'IDENTITY('.self::ALIAS.'.category) as categoryId')
        ->andWhere(self::ALIAS.'.status = 1')
        ->andWhere(self::ALIAS.'.paa_lite_field = 118');

        $PaaLiteFieldRules = $queryBuilder->getQuery()->getArrayResult();

        if (count($PaaLiteFieldRules)) {
            foreach ($PaaLiteFieldRules as $PaaLiteFieldRule) {
                $regNoFieldCategoryIds[] = $PaaLiteFieldRule['categoryId'];
            }
        }

        if ($container) {
            CommonManager::setCacheVersion($container, $cacheKey, $regNoFieldCategoryIds);
        }

        return $regNoFieldCategoryIds;
    }

    /**
     * Get category wise PAA field rules for one field.
     *
     * @param mixed   $categoryId Category id.
     * @param integer $PaaLiteFieldId Paa Field id.
     * @param mixed   $container  Container identifier.
     *
     * @return array
     */
    public function getPaaLiteFieldRuleArrayByCategoryIdForField($categoryId, $PaaLiteFieldId, $container)
    {
        if ($container) {
            $culture     = CommonManager::getCurrentCulture($container);
            $cacheKey    = $this->getTableName().'|'.__FUNCTION__.'|'.$categoryId.'_'.$PaaLiteFieldId.'_'.$culture;
            $cachedValue = CommonManager::getCacheVersion($container, $cacheKey);

            if ($cachedValue !== false) {
                return $cachedValue;
            }
        }

        $PaaLiteFieldRulesArray = array();

        $queryBuilder = $this->getPaaLiteFieldRulesQueryBuilderByCategoryId($categoryId);
        $queryBuilder->andWhere(self::ALIAS.'.paa_lite_field = :paa_lite_field')->setParameter('paa_lite_field', $PaaLiteFieldId);

        $PaaLiteFieldRules = $queryBuilder->getQuery()->getArrayResult();
        $PaaLiteFieldRulesArray[$categoryId] = $PaaLiteFieldRules;

        if ($container) {
            CommonManager::setCacheVersion($container, $cacheKey, $PaaLiteFieldRulesArray);
        }

        return $PaaLiteFieldRulesArray;
    }

    /**
     * Get PAA fields by category or category ancestor for one field.
     *
     * @param mixed   $categoryId Category id.
     * @param integer $PaaLiteFieldId Paa Field id.
     * @param mixed   $container  Container identifier.
     *
     * @return array
     */
    public function getPaaLiteFieldRuleArrayByCategoryAncestorForOneField($categoryId, $PaaLiteFieldId, $container)
    {
        $PaaLiteFieldRules = $this->getPaaLiteFieldRuleArrayByCategoryIdForField($categoryId, $PaaLiteFieldId, $container);

        if (isset($PaaLiteFieldRules[$categoryId]) && count($PaaLiteFieldRules[$categoryId])) {
            return $PaaLiteFieldRules[$categoryId];
        } else {
            $categoryPath = $this->_em->getRepository('FaEntityBundle:Category')->getCategoryPathArrayById($categoryId, false, $container);
            $categoryIds  = array_keys($categoryPath);
            if ($categoryIds && count($categoryIds) > 1) {
                $parentCategoryId = $categoryIds[(count($categoryIds) - 2)];
                $PaaLiteFieldRules = $this->getPaaLiteFieldRuleArrayByCategoryIdForField($parentCategoryId, $PaaLiteFieldId, $container);
                if (isset($PaaLiteFieldRules[$parentCategoryId]) && count($PaaLiteFieldRules[$parentCategoryId])) {
                    return $PaaLiteFieldRules[$parentCategoryId];
                }
            }
        }
    }


    /**
     * Get campaign wise PAA field rules.
     *
     * @param integer $campaignId Campaign id.
     * @param integer $categoryId Category id.
     *
     * @return array
     */
    public function getPaaLiteFieldRulesByCampaignId($campaignId = null, $categoryId = null, $ordBy = 'ord')
    {
        $query = $this->getPaaLiteFieldRulesQueryBuilderByCampaignId($campaignId, $ordBy)->getQuery();
        if ($ordBy == 'bothWithNullLast') {
            $query
            ->setHint(Query::HINT_CUSTOM_OUTPUT_WALKER,  'Fa\Bundle\CoreBundle\Walker\SortableNullsWalker')
            ->setHint('SortableNullsWalker.fields', array(
                'step' => SortableNullsWalker::NULLS_LAST,
            ));
        }
        return $query->getResult();
    }

    /**
     * Get campaign wise PAA field rules query.
     *
     * @param integer $campaignId Campaign id.
     * @param string  $ordBy      Order by ord, step or both
     *
     * @return object
     */
    public function getPaaLiteFieldRulesQueryBuilderByCampaignId($campaignId = null, $ordBy = 'ord')
    {
        $queryBuilder = $this->getBaseQueryBuilder()
                        ->select(self::ALIAS, PaaFieldRepository::ALIAS)
                        ->leftJoin(self::ALIAS.'.paa_lite_field', PaaFieldRepository::ALIAS)
                        ->where(self::ALIAS.'.campaign = '.$campaignId);

        if ($ordBy == 'both' || $ordBy == 'bothWithNullLast') {
            $queryBuilder->addOrderBy(self::ALIAS.'.step', 'asc')
                         ->addOrderBy(self::ALIAS.'.ord', 'asc');
        } else {
            $queryBuilder->addOrderBy(self::ALIAS.'.'.$ordBy, 'asc');
        }
        
        return $queryBuilder;
    }
    
    public function getAllPaaLiteFields($campaignId) 
    {
        $queryBuilder = $this->createQueryBuilder(self::ALIAS)
        ->where(self::ALIAS.'.is_added = 1')
        ->andWhere(self::ALIAS.'.status = 1')
        ->andWhere(self::ALIAS.'.campaign = :campaignId')
        ->setParameter('campaignId', $campaignId)
        ->orderBy(self::ALIAS.'.ord','asc')
        ->getQuery()->getResult();
        
        return $queryBuilder;
    }

    public function getAllPaaLiteFieldsByCampId($campaignId) 
    {
        $queryBuilder = $this->createQueryBuilder(self::ALIAS)
        ->where(self::ALIAS.'.campaign = :campaignId')
        ->setParameter('campaignId', $campaignId)
        ->getQuery()->getResult();
        
        return $queryBuilder;
    }

    public function getPaaLiteFieldsByCampId($campaignId) 
    {
        $existPaaField = array();
        $PaaLiteFieldRules = $this->createQueryBuilder(self::ALIAS)
        ->where(self::ALIAS.'.campaign = :campaignId')
        ->setParameter('campaignId', $campaignId)
        ->andWhere(self::ALIAS.'.is_added = 1')
        ->getQuery()->getResult();

         if (count($PaaLiteFieldRules)) {
            foreach ($PaaLiteFieldRules as $PaaLiteFieldRule) {
                $existPaaField[] = $PaaLiteFieldRule->getPaaLiteField()->getId();
            }
        }
        return $existPaaField;
    }

    public function getDetailByCampaignIdPaaField($paaField, $campaignId) 
    {
        $queryBuilder = $this->createQueryBuilder(self::ALIAS)
        ->where(self::ALIAS.'.campaign = :campaignId')
        ->setParameter('campaignId', $campaignId)
        ->andWhere(self::ALIAS.'.paa_lite_field = :paaField')
        ->setParameter('paaField', $paaField)
        ->getQuery()->getResult();
        
        return $queryBuilder;
    }

    /**
     * Get campaign wise PAA field rules.
     *
     * @param integer $campaignId Campaign id.
     * @param integer $categoryId Category id.
     *
     * @return array
     */
    public function getPaaLiteFieldRulesByCampaignIdWithAdded($campaignId = null, $categoryId = null, $ordBy = 'ord')
    {
        $query = $this->getPaaLiteFieldRulesQryByCampaignIdWithAdded($campaignId, $ordBy)->getQuery();
        if ($ordBy == 'bothWithNullLast') {
            $query
            ->setHint(Query::HINT_CUSTOM_OUTPUT_WALKER,  'Fa\Bundle\CoreBundle\Walker\SortableNullsWalker')
            ->setHint('SortableNullsWalker.fields', array(
                'step' => SortableNullsWalker::NULLS_LAST,
            ));
        }
        return $query->getResult();
    }

    /**
     * Get campaign wise PAA field rules query.
     *
     * @param integer $campaignId Campaign id.
     * @param string  $ordBy      Order by ord, step or both
     *
     * @return object
     */
    public function getPaaLiteFieldRulesQryByCampaignIdWithAdded($campaignId = null, $ordBy = 'ord')
    {
        $queryBuilder = $this->getBaseQueryBuilder()
                        ->select(self::ALIAS, PaaFieldRepository::ALIAS)
                        ->leftJoin(self::ALIAS.'.paa_lite_field', PaaFieldRepository::ALIAS)
                        ->where(self::ALIAS.'.campaign = '.$campaignId)
                        ->andWhere(self::ALIAS.'.is_added=1');

        if ($ordBy == 'both' || $ordBy == 'bothWithNullLast') {
            $queryBuilder->addOrderBy(self::ALIAS.'.step', 'asc')
                         ->addOrderBy(self::ALIAS.'.ord', 'asc');
        } else {
            $queryBuilder->addOrderBy(self::ALIAS.'.'.$ordBy, 'asc');
        }
        
        return $queryBuilder;
    }

    
}
