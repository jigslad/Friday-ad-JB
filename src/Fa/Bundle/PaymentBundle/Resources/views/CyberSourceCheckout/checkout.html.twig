{% extends 'FaFrontendBundle::layout.html.twig' %}
{% form_theme form 'FaFrontendBundle:Form:fields.html.twig' %}

{% block body %}
    {{ form_start(form, {'attr': {'novalidate': '', 'id': 'cyber_source_form'}}) }}
    <div class="payment">
    		<div class="container">
    			<div class="row">
    				<div class="col-md-24">
                        <div class="mt10">
                        	{% if subscription != 1 %}
                                <a href="{{ path('show_cart') }}" class="paa-back-arrow">{{'Go back'|trans({}, 'frontend-ad-package')}}</a>
                            {% else %}
                                <a href="{{ path('user_package_choose_profile', {'from': 'profile'}) }}" class="paa-back-arrow">{{'Go back'|trans({}, 'frontend-ad-package')}}</a>
                            {% endif %}
                        </div>
    					<div class="col-md-24 d-flex justify-content-center">
    						{% if trial == 1 %}
                               <h1 class="s-h1 paa-title col-md-24 col-lg-18 text-center">{{'Add payment source'|trans({},'frontend-cyber-source')}}</h1>
                                <div align="center">{{'To continue with your one month free trial please add a valid card to your account.'|trans({},'frontend-cyber-source')}}</div>
                                <br /> 
                                <div align="center">{{'No payment will be taken until the trial period ends, and you are free to cancel before this time.'|trans({},'frontend-cyber-source')}}</div>
                            {% else %}
                                <h1 class="s-h1 paa-title col-md-24 col-lg-18 text-center">{{'Payment'|trans({},'frontend-cyber-source')}}</h1>
                            {% endif %}
    					</div>
    				</div>
    			</div>
    		</div>
    		<div id="card_detail" style="display:none">
            <div class="white-bg">
                <div class="container">
                    <div class="row">
                        <div class="col-md-24">
                            <div class="small-wrapper">                            	
                                <div class="paa-bdr-box bdr-none">
                                	<div {% if form.payment_method.vars.choices|length == 1 %}style="display:none;"{% endif %}>
                                        <h3 class="text-center">{{'Choose payment method'|trans({},'frontend-cyber-source')}}</h3>
                                        <ul class="choose-payment-method payment-card-option-block ml0" id="payment_method_id">
                                            {% for choice in form.payment_method.vars.choices %}
                                            <li>
                                                <div class="d-flex mt10 mb10">
                                                    <span class="grey-radio d-inline-flex {% if form.payment_method.vars.data == choice.value %}checked{% endif %} ">
                                                       <input class="checkbox" onclick="return showHideCardDetail();" type="radio" value="{{ choice.value }}" {% if form.payment_method.vars.data == choice.value %}checked="checked"{% endif %} name="{{ form.payment_method.vars.full_name }}" id="{{ form.payment_method.vars.id }}_{{ choice.value }}" />
                                                        <label for="{{ form.payment_method.vars.id }}_{{ choice.value }}"></label>{{ choice.label|raw }}
                                                    </span>
                                                    {% if choice.value %}
                                                        <a href="{{ path('cybersource_delete_token', {'id': choice.value, 'subscription': subscription}) }}" onclick="javascript:return confirm('{{ 'Do you want to proceed deleting this option?'|trans({}, 'frontend-cyber-source') }}')" class="delete-icon"></a>
                                                    {% endif %}
                                                    {% if loop.index == form.payment_method.vars.choices|length %}
                                                        {{ form_errors(form.payment_method) }}
                                                    {% endif %}
                                                </div>
                                            </li>
                                            {% endfor %}
                                            {% do attribute(form, 'payment_method').setRendered %}
                                        </ul>
                                    </div>
            
                                    <h3 class="text-center">{{'Billing details'|trans({},'frontend-cyber-source')}}</h3>
                                    <div class="payment-row first-row">
                                        {{ form_row(form.street_address) }}                                    
                                    </div>
                                    <div class="payment-row">
                                        {{ form_label(form.zip) }}
                                        <div class="postcode clearfix">
                                            {{ form_widget(form.zip) }}
                                            <button type="button" class="btn secondary-btn-1 right" onclick="return getUserAddress();">{{'Find address'|trans({},'frontend-cyber-source')}}</button>
                                        </div>
                                        <small id="zip_error_div" class="error" style="display:none"></small>
                                        <span id="form_zip_error">{{ form_errors(form.zip) }}</span>
                                    </div>
                                    <div class="payment-row">
                                         {{ form_row(form.street_address_2) }}                                   
                                     </div>
                                    <div class="payment-row">
                                        {{ form_row(form.town) }}
                                    </div>
                                    <div class="payment-row">
                                        {{ form_row(form.county) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="checkout">
                <div class="container">
                    <div class="row">
                        <div class="col-md-24">
                            <div class="small-wrapper">
                                <div class="paa-bdr-box bdr-none">
                                    <h3 class="text-center">Card details</h3>
                                    <div class="payment-cards mt20">&nbsp;</div>
                                        <div class="payment-row">
                                            {{ form_label(form.card_holder_name) }}
                                            {{ form_widget(form.card_holder_name, {'attr': {'class': 'white-field'}}) }}
                                            {{ form_errors(form.card_holder_name) }}                                        
                                        </div>
                                        <div class="payment-row card-num">
                                            {{ form_label(form.card_number) }}
                                            {{ form_widget(form.card_number, {'attr': {'class': 'white-field'}}) }}
                                            {{ form_errors(form.card_number) }}
                                        </div>
                                        
                                        <div class="payment-row white-select">
                                            {{ form_label(form.card_expity_month) }}
                                            <div class="expiry-date">
                                                <div class="l-select">{{ form_widget(form.card_expity_month, {'attr': {'class': 'select-control'}}) }}</div>
                                                <div class="r-select">{{ form_widget(form.card_expity_year, {'attr': {'class': 'select-control'}}) }}</div>
                                            </div>
                                            {{ form_errors(form.card_expity_month) }}
                                            {{ form_errors(form.card_expity_year) }}
                                        </div>
                                        
                                        <div class="payment-row security-code">
                                            {{ form_label(form.card_security_code) }}
                                            {{ form_widget(form.card_security_code, {'attr': {'class': 'white-field'}}) }}
                                            <div class="sec-code-icon">{{'Security code'|trans({},'frontend-cyber-source')}}</div>
                                            {{ form_errors(form.card_security_code) }}
                                        </div>
                                        
                                        <div class="payment-row">
                                            <div class="label-inline white-check">
                                                {{ form_widget(form.is_save_credit_card, {'attr':{'class':'checkbox'}}) }}
                                                {% if subscription != 1 %}
                                                    <label for="{{ form.is_save_credit_card.vars.id }}"></label>{{ form_label(form.is_save_credit_card) }}
                                                {% endif %}
                                                {{ form_errors(form.is_save_credit_card) }}
                                            </div>
                                        </div>
                                    </div>
                                    <div id="pay_now_btn" style="display:none;">
                                        {{ form_widget(form.save, {'attr': {'class':'primary-btn-1 btn btn-block btn-place-ad'}}) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
            	</div>
            </div>
          </div>
    {{ form_end(form) }}
{% endblock %}

{% block scriptbottom %}
    {{ include('FaCoreBundle:Default:blockJs.html.twig') }}
    <script language="javascript" type="text/javascript">
    //<![CDATA[
    $(document).ready(function(){
        {% if (gaStr is defined and gaStr != '') %}
            ga('send', 'event', 'Category PAA - Checkout', 'Form error', '{{gaStr}}');
        {% endif %}
        
        {% if app.request.getMethod() != 'POST' %}
            $("#payment_method_id input:radio[name='fa_payment_cyber_source_checkout[payment_method]']:first").attr('checked', true);
            $("#payment_method_id input:radio[name='fa_payment_cyber_source_checkout[payment_method]']:first").trigger('click');
        {% endif %}
        showHideCardDetail();
    });
    
    $('#fa_payment_cyber_source_checkout_save').click(function(){
        blockPage();
        $(this).attr('disabled', true);
        $('#cyber_source_form').submit();
        return false;
    });
    function getUserAddress()
    {
        blockPage();
        $.ajax({
            type: "POST",
            url : '{{ path("ajax_get_user_address") }}',
            data: { postCode: $('#fa_payment_cyber_source_checkout_zip').val()}
        })
        .always(function(response) {
            unblockPage();
        })
        .done(function(response) {
            $('#form_zip_error').hide();
            if (response.errorMsg.length) {
                //clearForm($('#cyber_source_form'));
                $('#zip_error_div').html(response.errorMsg);
                $('#zip_error_div').show();
            } else {
                $('#zip_error_div').hide();
                if (response.street_address && response.street_address.length) {
                    $('#fa_payment_cyber_source_checkout_street_address').val(response.street_address);
                    $('#fa_payment_cyber_source_checkout_street_address').focus();
                }
                if (response.street_address_2 && response.street_address_2.length) {
                    $('#fa_payment_cyber_source_checkout_street_address_2').val(response.street_address_2);
                    $('#fa_payment_cyber_source_checkout_street_address_2').focus();
                }
                if (response.town_name && response.town_name.length) {
                    $('#fa_payment_cyber_source_checkout_town').val(response.town_name);
                    $('#fa_payment_cyber_source_checkout_town').focus();
                }
                if (response.domicile_name && response.domicile_name.length) {
                    $('#fa_payment_cyber_source_checkout_county').val(response.domicile_name);
                    $('#fa_payment_cyber_source_checkout_county').focus();
                }
            }
        });
    }
    
    function showHideCardDetail()
    {
        var paymentMethod = $("input[name='fa_payment_cyber_source_checkout[payment_method]']:checked").val();
        //if (paymentMethod == 0) {
            $('#card_detail').show();
            $('.select-control').selectmenu().selectmenu('refresh',true);
            $('#pay_now_btn').removeClass('checkout')
        /*} else {
            $('#card_detail').hide();
            clearForm('#card_detail');
            $('.expiry-date').nextAll('small.error').first().remove();
            $('.expiry-date').nextAll('small.error').first().remove();
            $('#pay_now_btn').addClass('checkout')
        }*/
        $('#pay_now_btn').show();
        bindFormErrorEvents();
    }
    //]]>
    </script>
{% endblock %}