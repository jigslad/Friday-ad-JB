{% extends 'FaFrontendBundle::layout.html.twig' %}

{% set container = fetch_container_instance() %}
{% set categoryRepository = fetch_repository('FaEntityBundle:Category') %}
{% set userCreditRepository = fetch_repository('FaUserBundle:UserCredit') %}

{% block title %}
    {{'My Credits'|trans({}, 'frontend-my-credits')}}
{% endblock %}

{% block stylesheet %}
    <link rel="stylesheet" href="{{ asset('build/css/dashboard.css') }}"/>
{% endblock %}

{% block body -%}
    <div class="dash-block">
        <div class="posting-bg" id="my_credits">
            <div class="container">
                <div class="row d-board-main">
            {{ include('FaUserBundle:Default:leftCanvasMenuLink.html.twig') }}
                    <div class="off-canvas-wrap" data-offcanvas>
                        <div class="inner-wrap">
                            {{ include('FaUserBundle:Default:userLeftMenu.html.twig') }}
                            <div id="db-right-part" class="col-md-19 d-right-col">
                                <div id="manage-my-ads-list-only">
                                    <h1 class="s-h1 db-title mt30 mb20">{{'Credits'|trans({}, 'frontend-my-credits')}}</h1>

                                    <div class="row">
                                        <div class="col-md-18">
                                            <h2 class="s-h2 mb10">
                                                {{'View all your active credits. To use them, just place an ad and click \'Use credit\' when choosing your package'|trans({}, 'frontend-my-credits')|raw}}
                                            </h2>
                                        </div>
                                        <div class="col-md-6 mb20">
                                            <a href="{{ path('ad_post_first_step') }}" class="primary-btn-1 btn btn-block next-btn btn-h-lg">{{'Place an ad'|trans({}, 'frontend-my-credits')}}</a>
                                        </div>
                                    </div>
                                    <div class="mb20">
                                        <h3 class="s-h3">
                                            {{'Total credits:'|trans({}, 'frontend-manage-my-ad')}} {{ userCreditRepository.getActiveCreditCountForUser(app.user.getId()) }}
                                        </h3>
                                    </div>
                                    <div id="manage-credits">
                                        {% if userCredits|length %}
                                            <div class="db-section">
                                            {% for userCreditCategoryId, userCredit in userCredits %}
                                                {% set categoryClassName = staticCall('Fa\\Bundle\\CoreBundle\\Manager\\CommonManager', 'getCategoryClassNameById', [userCreditCategoryId])|replace({'_':'-'}) %}
                                                <div class="db-list">
                                                    <a class="panel-heading {% if loop.index == 1 %}collapsed{% endif %}" data-toggle="collapse" data-target="#panel{{categoryClassName}}">
                                                        <div class="media section-head">
                                                            <div class="media-body">
                                                                <span class="{{categoryClassName}}-icon manage-credits-icon">{{ categoryRepository.getRootCategoryName(userCreditCategoryId, container)|replace({'_': ' '})|capitalize }} ({{ userCredit['credit'] }})</span>
                                                            </div>
                                                            <div class="arrow-block">
                                                                <i class="fa fa-chevron-up"></i>
                                                                <i class="fa fa-chevron-down"></i>
                                                            </div>
                                                        </div>
                                                    </a>
                                                    <div id="panel{{categoryClassName}}" class="collapse {% if loop.index == 1 %}show{% endif %}">
                                                        <div class="credit-blocks">
                                                            <div class="row collapse-body-content">
                                                                {% for userCreditDetail in userCredit %}
                                                                    {% if userCreditDetail['package_sr_no'] is defined %}
                                                                        <div class="col-md-12 col-lg-8">
                                                                            <div class="card mb10">
                                                                                <div class="card-body">
                                                                                    <h5 class="card-title">
                                                                                        {% set creditTitle = {} %}
                                                                                        {% for userCreditPackageSrNo in userCreditDetail['package_sr_no'] %}
                                                                                            {% set creditTitle = creditTitle|merge({0 : userCreditRepository.getCreditPackageName(userCreditPackageSrNo)}) %}
                                                                                        {% endfor %}
                                                                                        {{ creditTitle|join(' + ') }}
                                                                                    </h5>
                                                                                    <label class="card-text">{{'%credits% credits remaining'|trans({'%credits%': userCreditDetail['credit'] }, 'frontend-my-credits')}}</label>
                                                                                    <p class="card-text mt5">
                                                                                        <small class="text-muted">
                                                                                            <em>
                                                                                                {% if userCreditDetail['expires_at'] is not null %}
                                                                                                    {{'Expiry date:'|trans({}, 'frontend-my-credits')}} {{ staticCall('Fa\\Bundle\\CoreBundle\\Manager\\CommonManager', 'formatDate', [userCreditDetail['expires_at'], container, null, null, 'd MMMM YYYY']) }}
                                                                                                {% else %}
                                                                                                    {{'Expiry date:'|trans({}, 'frontend-my-credits')}} {{'Infinite'|trans({}, 'frontend-my-credits')}}
                                                                                                {% endif %}
                                                                                            </em>
                                                                                        </small>
                                                                                    </p>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    {% endif %}
                                                                {% endfor %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                            </div>
                                        {% else %}
                                            {{'No credits available.'|trans({}, 'frontend-my-credits')}}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scriptbottom %}
    <script src="{{ asset_url('fafrontend/js/jquery.equalizer.min.js') }}"></script>
    <script language="javascript" type="text/javascript">
    //<![CDATA[
        $(document).ready(function() {
            bindEqualizerEvent();
        });
        $(document).foundation({
            accordion: {
                multi_expand: true,
                callback : function (accordion) {
                    accordionCallback(accordion);
                }
            }
        });

        $('#my_credits .accordion-navigation .content').each(function(){
            if ($(this).hasClass('active')) {
                $(this).siblings('a').find('span:eq(1)').addClass('dark-arrow-up');
                $(this).siblings('a').find('span:eq(1)').removeClass('dark-arrow-down');
            } else {
                $(this).siblings('a').find('span:eq(1)').addClass('dark-arrow-down');
                $(this).siblings('a').find('span:eq(1)').removeClass('dark-arrow-up');
            }
        });
        
        function accordionCallback(accordion)
        {
            $(accordion).siblings('a').find('span:eq(1)').toggleClass("dark-arrow-down dark-arrow-up");
            bindEqualizerEvent();
        }

        function bindEqualizerEvent()
        {
            $('.credit-blocks').equalizer({
                columns: '> ul > li > div',
                useHeight: 'i',
                resizeable: true,
                min: 70,
                breakpoint: null,
                disabled: 'breakpoint',
                overflow: 'overflowed'
            });
        }
    //]]>
    </script>
{% endblock %}